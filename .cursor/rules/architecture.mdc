# 架构规范

## 架构概述

采用分层架构设计，确保职责分离和依赖倒置：

```
页面/组件 → Composable（可选）→ Store（可选）→ Repo（可选）→ Services/API
```

## 分层职责

| 层级 | 职责 | ✅ 允许 | ❌ 禁止 |
|-----|---|---|---|
| **页面/组件** | UI 展示与交互 | 调用 Composable/Store，处理用户交互 | 直接访问 Repo/Services，包含业务逻辑 |
| **Composable** | 页面级业务逻辑 | 封装复杂交互，组合多个 Store，UI 逻辑（通知、确认框） | 直接访问 Repo/Services，持久化逻辑 |
| **Store**（可选） | 全局状态管理 | 维护状态，增删改查，调用 Repo/Services，记录日志 | UI 交互逻辑，直接访问缓存/API |
| **Repo**（可选） | 数据访问抽象 | 封装存储细节，暴露稳定 API，批量读写 | 业务逻辑，被页面直接调用 |
| **Services** | Node 能力封装 | 通过 `window.services` 暴露 Node 能力 | 在 Vue 组件中直接使用 `require` |

## Composable 适用场景

- 复杂表单（多步骤、多校验）
- 跨模块数据协调
- 页面特定交互逻辑（导航、通知、确认框）
- 复杂业务逻辑封装

**简单页面可直接使用 Store 或直接调用 Services**

## 架构约定

### Services 层

- 所有新的 Node 能力必须在 `public/preload/services.js` 暴露，由 `window.services` 提供给渲染层。
- 不得在 Vue 组件中直接使用 `require`。
- 更新 `window.services` 后，务必同步修改 `src/env.d.ts` 中的类型声明，保持类型安全。

```typescript
// ✅ 正确：通过 window.services 访问 Node 能力
const content = window.services.readFile(filePath)

// ❌ 错误：直接使用 require
const fs = require('fs')
```

### 路由管理

- 在 `App.vue` 中通过 `window.utools.onPluginEnter/Out` 维护路由状态。
- 新增功能页时同步扩展此路由逻辑。
- 每个功能页组件放在 `src/views/` 目录，命名使用PascalCase（如 `Login.vue`），并接受 `enterAction: PluginEnterAction` 作为必要 prop。

```vue
<!-- ✅ 正确：路由管理 -->
<template>
  <template v-if="route === 'hello' && enterAction">
    <Hello :enterAction="enterAction!" />
  </template>
  <template v-if="route === 'read' && enterAction">
    <Read :enterAction="enterAction!" />
  </template>
</template>
```

### 目录结构

本项目采用混合组织方式，适用于中小型Vue项目。详细规范请参考 [目录结构规范](directory-structure.mdc)。

**核心目录说明**：

- **views/**：页面级组件，与路由/功能入口对应（如 `Login.vue`、`TopicList.vue`）
- **components/**：可复用通用UI组件，使用 `cu-` 前缀（如 `cu-button.vue`）
- **composables/**：
  - 通用composables直接放在根目录（如 `useAuth.ts`、`useNotification.ts`）
  - 业务composables按功能模块组织子目录（如 `topic/useTopicManagement.ts`）
- **stores/**：Pinia状态管理，扁平化组织，按功能命名（如 `user.ts`、`topic.ts`）
- **repos/**：数据仓库层，命名使用 `Repo` 后缀（如 `item-repo.ts`）
- **api/**：API接口层，按业务模块命名（如 `user.ts`、`topic.ts`）
- **types/**：类型定义，API类型放在 `types/api/` 子目录
- **constants/**：常量定义（颜色、配置、枚举等）

## 数据流

### 读取流程

```
用户操作 → 页面组件 → Composable → Store → Repo → Services/API → 数据返回
```

### 写入流程

```
用户操作 → 页面组件 → Composable → Store → 数据验证 → Repo → Services/API → 状态更新
```

### 错误处理流程

```
错误发生 → Repo/Services/API → Store → Composable → 页面组件 → 用户提示
```
